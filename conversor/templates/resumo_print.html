{% extends "base.html" %}

{% block titulo %}
Impress√£o do Resumo ‚Äî {{ resumo.nome_treino }}
{% endblock %}

{% block content %}
<style>
  /* P√°gina A4 com margem */
  @page { size: A4; margin: 14mm; }

  @media print {
    /* Esconde header/rodap√©/menus */
    header, nav, footer,
    .navbar, .site-header, .site-footer,
    .no-print, [data-print="hide"] {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
    }

    /* Fundo 100% branco, ignorando o bg do base.html */
    html, body,
    main, #app, .page, .container,
    .bg-gray-50, .bg-gray-100, .bg-slate-50 {
      background: #fff !important;
    }

    /* Tipografia compacta */
    html, body { font-size: 12px; line-height: 1.25; }
    h1 { font-size: 18px !important; margin: 0 0 6px !important; }
    h2 { font-size: 14px !important; margin: 8px 0 4px !important; }
    h3 { font-size: 13px !important; margin: 6px 0 4px !important; }
    p  { margin: 2px 0 !important; }

    /* Container e cart√µes */
    .print-card { box-shadow: none !important; border-color: #e5e7eb !important; background:#fff !important; }
    .print-wrap { padding-top: 6mm !important; padding-bottom: 4mm !important; }
    .print-pad  { padding: 12px !important; }

    /* Grid 2 colunas */
    .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px !important; }

    /* Cards de categoria */
    .print-item { padding: 8px !important; border-radius: 8px !important; page-break-inside: avoid; }

    /* Listas compactas */
    .print-list { margin: 0 0 0 16px !important; }
    .print-list li { margin: 0 !important; padding: 0 !important; }

    /* Manter cores no print */
    :root { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    /* Paleta por categoria (ajuste como preferir) */
      /* cores por categoria */
      .cat-macro { background:#ccdbfd!important; border-color:#abc4ff !important; }
      .cat-ele   { background:#d7e3fc !important; border-color:#abc4ff !important; }
      .cat-stim  { background:#e2eafc !important; border-color:#abc4ff !important; }
      .cat-vit   { background:#edf2fb !important; border-color:#abc4ff !important; }
      .cat-amino { background:#edf2fb !important; border-color:#abc4ff !important; }
    

    /* Logo menor no print */
    .print-logo { height: 28px !important; }
  }
</style>

{% macro formatar_tempo_decimal(decimal) %}
  {% if decimal is not none %}
    {% set horas = decimal|int %}
    {% set minutos = ((decimal - horas) * 60)|round(0, 'floor') %}
    {{ horas }}h{{ "%02d"|format(minutos) }}m
  {% else %}-{% endif %}
{% endmacro %}

<div class="max-w-4xl mx-auto bg-white p-6 rounded shadow print-card print-wrap print-pad">

  <!-- LOGO agora DENTRO do wrapper branco -->
  <div class="flex items-center justify-center mb-4">
    <img src="{{ url_for('static', filename='image/logotc-navbar.png') }}"
         alt="Logo" class="h-12 print-logo">
  </div>

  <h1 class="text-2xl font-bold mb-2">{{ resumo.nome_treino }}</h1>
  <p class="text-sm text-gray-600 mb-4">{{ resumo.data.strftime('%d/%m/%Y') }}</p>

  {% if resumo.comentario %}
  <div class="mb-6">
    <h2 class="text-lg font-semibold mb-1">üìù Coment√°rio</h2>
    <p class="whitespace-pre-wrap">{{ resumo.comentario }}</p>
  </div>
  {% endif %}

  {% if resumo.suplementos_utilizados %}
  <div class="mb-6">
    <h2 class="text-lg font-semibold mb-1">üß™ Suplementos utilizados</h2>
    <ul class="list-disc list-inside text-sm text-gray-700">
      {% for item in resumo.suplementos_utilizados.split(',') %}
        <li>{{ item.strip() }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="mb-6">
    <h2 class="text-lg font-semibold mb-1">‚è±Ô∏è Tempos</h2>
    <p><strong>Total:</strong> {{ formatar_tempo_decimal(resumo.tempo_total) }}</p>
    <p>
      <strong>Nata√ß√£o:</strong> {{ formatar_tempo_decimal(resumo.tempo_natacao) }} |
      <strong>Bike:</strong> {{ formatar_tempo_decimal(resumo.tempo_bike) }} |
      <strong>Corrida:</strong> {{ formatar_tempo_decimal(resumo.tempo_corrida) }}
    </p>
  </div>

  {% set ordem = ["Macronutrientes","Eletr√≥litos","Estimulantes e Compostos","Vitaminas","Amino√°cidos"] %}
  {% set ordem_eletrolitos = ["S√≥dio","Magn√©sio","Pot√°ssio","C√°lcio"] %}
  {% set classe_cat = {
    "Macronutrientes":"cat-macro",
    "Eletr√≥litos":"cat-ele",
    "Estimulantes e Compostos":"cat-stim",
    "Vitaminas":"cat-vit",
    "Amino√°cidos":"cat-amino"
  } %}

  <div class="print-grid">
    {% for categoria in ordem %}
      {% if resumo.resumo_dados.get(categoria) %}
        {% set dados = resumo.resumo_dados[categoria] %}
        {% if categoria == "Eletr√≥litos" %}
          {% set total = namespace(v=0) %}
          {% for k in ordem_eletrolitos %}{% set total.v = total.v + (dados.get(k,0) or 0) %}{% endfor %}
          {% set mostrar = total.v > 0 %}
        {% else %}
          {% set soma = dados.values() | map('float') | sum %}
          {% set mostrar = soma > 0 %}
        {% endif %}

        {% if mostrar %}
        <div class="p-3 rounded border print-item {{ classe_cat.get(categoria,'') }}">
          <h3 class="font-semibold text-gray-900 mb-1">
            {{ "üíß" if categoria=="Eletr√≥litos" else ("üî•" if categoria=="Macronutrientes" else ("‚ö°" if categoria=="Estimulantes e Compostos" else ("üíä" if categoria=="Vitaminas" else "üß¨"))) }}
            {{ categoria }}
          </h3>
          <ul class="list-disc list-inside text-sm text-gray-800 print-list">
            {% if categoria == "Eletr√≥litos" %}
              {% for item in ordem_eletrolitos %}
                {% set valor = dados.get(item,0) %}
                {% if valor > 0 %}
                  <li><strong>{{ item }}:</strong>
                    {{ valor|round(1) }} {{ unidades[categoria].get(item,'') }}/h ‚á•
                    {{ (valor * resumo.tempo_total)|round(1) }} {{ unidades[categoria].get(item,'') }} total
                  </li>
                {% endif %}
              {% endfor %}
            {% else %}
              {% for item, valor in dados.items() if valor > 0 %}
                <li><strong>{{ item }}:</strong>
                  {{ valor|round(1) }} {{ unidades[categoria].get(item,'') }}/h ‚á•
                  {{ (valor * resumo.tempo_total)|round(1) }} {{ unidades[categoria].get(item,'') }} total
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</div>

<script>
  window.addEventListener("load", () => window.print());
  window.addEventListener("afterprint", () => window.close());
</script>

{% endblock %}