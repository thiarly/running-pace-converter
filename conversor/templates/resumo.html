{% extends "base.html" %}

{% block titulo %}
Resumo do Planejamento
{% endblock %}

{% block content %}


{% macro formatar_tempo_decimal(decimal) %}
  {% set horas = decimal|int %}
  {% set minutos = ((decimal - horas) * 60)|round(0, 'floor') %}
  {{ horas }}h{{ "%02d"|format(minutos) }}m
{% endmacro %}



<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-6">
      {% for category, message in messages %}
        <div class="p-4 rounded-md text-white {{ 'bg-green-500' if category == 'success' else 'bg-red-500' }} flash-message">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

  <h1 class="text-2xl font-bold text-left text-gray-800 mb-6 border-b pb-2">Resumo do Planejamento</h1>


  <form method="POST" class="grid grid-cols-1 md:grid-cols-3 sm:grid-cols-2 gap-6 mb-8">
    {{ form.hidden_tag() }}

    <div>
      <label class="block text-sm font-medium text-gray-700">üèä Horas Nata√ß√£o</label>
      {{ form.tempo_natacao_horas(class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md") }}
      <label class="block text-sm font-medium text-gray-700 mt-2">‚è±Ô∏è Minutos Nata√ß√£o</label>
      {{ form.tempo_natacao_minutos(class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md") }}
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700">üö¥ Horas Bike</label>
      {{ form.tempo_bike_horas(class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md") }}
      <label class="block text-sm font-medium text-gray-700 mt-2">‚è±Ô∏è Minutos Bike</label>
      {{ form.tempo_bike_minutos(class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md") }}
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700">üèÉ Horas Corrida</label>
      {{ form.tempo_corrida_horas(class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md") }}
      <label class="block text-sm font-medium text-gray-700 mt-2">‚è±Ô∏è Minutos Corrida</label>
      {{ form.tempo_corrida_minutos(class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md") }}
    </div>

    <div class="md:col-span-2 md:col-span-3 flex flex-col sm:flex-row justify-center gap-4 mt-4">
      <button type="submit" name="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md">Calcular Resumo</button>
      <button type="submit" name="limpar" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-6 py-2 rounded-md">Limpar Tela</button>
    </div>
  </form>


  {% if totais %}
  <div class="text-center text-lg font-medium mb-6">
    Tempo Total de Treino ‚è±Ô∏è: <strong>{{ formatar_tempo_decimal(tempo_total|float) }}</strong>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
    {% set ordem = ["Macronutrientes", "Eletr√≥litos", "Estimulantes e Compostos",  "Vitaminas", "Amino√°cidos"] %}
    {% set ordem_eletrolitos = ["S√≥dio", "Magn√©sio", "Pot√°ssio", "C√°lcio"] %}
    {% set icones = {
      "Macronutrientes": "üî•",
      "Eletr√≥litos": "üíß",
      "Estimulantes e Compostos": "‚ö°",
      "Vitaminas": "üíä",
      "Amino√°cidos": "üß¨"
    } %}
    {% set cores = {
      "Macronutrientes": "bg-blue-200",
      "Eletr√≥litos": "bg-blue-100",
      "Estimulantes e Compostos": "bg-teal-50",
      "Vitaminas": "bg-teal-50",
      "Amino√°cidos": "bg-teal-50"
    } %}

    {% for categoria in ordem %}
      {% if resumo[categoria] %}
        <div class="{% if categoria in ['Macronutrientes', 'Eletr√≥litos'] %}md:col-span-3{% else %}md:col-span-1{% endif %} rounded-xl shadow p-4 {{ cores[categoria] }}">
          <h3 class="font-bold text-gray-800 mb-2">{{ icones[categoria] }} {{ categoria }}</h3>
          <ul class="list-disc pl-5 text-sm text-gray-700">
            {% if categoria == "Eletr√≥litos" %}
              {% for item in ordem_eletrolitos %}
                <li><strong>{{ item }}:</strong> {{ resumo[categoria][item] }}</li>
              {% endfor %}
            {% else %}
              {% for nome, valor in resumo[categoria].items() %}
                <li><strong>{{ nome }}:</strong> {{ valor }}</li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <form method="POST" action="{{ url_for('salvar_resumo') }}" class="mt-8 max-w-xl mx-auto bg-gray-200 p-4 rounded shadow">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="tempo_natacao_horas" value="{{ form.tempo_natacao_horas.data }}">
    <input type="hidden" name="tempo_natacao_minutos" value="{{ form.tempo_natacao_minutos.data }}">
    <input type="hidden" name="tempo_bike_horas" value="{{ form.tempo_bike_horas.data }}">
    <input type="hidden" name="tempo_bike_minutos" value="{{ form.tempo_bike_minutos.data }}">
    <input type="hidden" name="tempo_corrida_horas" value="{{ form.tempo_corrida_horas.data }}">
    <input type="hidden" name="tempo_corrida_minutos" value="{{ form.tempo_corrida_minutos.data }}">

    <h2 class="text-lg font-semibold mb-4">üóÇÔ∏è Salvar Resumo </h2>
    <div class="mb-3">
      <label class="block font-medium text-gray-700 mb-1">Nome do Treino</label>
      <input type="text" name="nome_treino" required class="w-full border rounded px-3 py-2">
    </div>
    <div class="mb-3">
      <label class="block font-medium text-gray-700 mb-1">Data</label>
      <input type="date" name="data" required class="w-full border rounded px-3 py-2" value="{{ current_date }}">
    </div>
    <div class="mb-3">
      <label class="block font-medium text-gray-700 mb-1">Coment√°rio</label>
      <textarea name="comentario" rows="3" class="w-full border rounded px-3 py-2" placeholder="Ex: Usei esse combo e me senti muito bem."></textarea>
    </div>

    <input type="hidden" name="resumo_dados" value='{{ resumo | tojson }}'>
    <div class="text-right">
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">Salvar Resumo</button>
    </div>
  </form>
  {% endif %}
</div>



{% if resumos %}

<hr class="my-10 border-t-2 border-gray-300">

<div class="text-center mb-6">
  <h2 class="text-xl font-bold text-gray-800"> Resumos Salvos</h2>
</div>

<div class="mt-10 max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">


  <form method="get" class="mb-6 max-w-md">
    <input type="text" id="campoBusca" placeholder="Buscar por t√≠tulo ou coment√°rio üîé"
           class="w-full px-4 py-2 border rounded shadow-sm">
  </form>
  
  <div id="resumosContainer">
    {% set icones = {
      "Macronutrientes": "üî•",
      "Eletr√≥litos": "üíß",
      "Vitaminas": "üíä",
      "Estimulantes e Compostos": "‚ö°",
      "Amino√°cidos": "üß¨"
    } %}
    
    {% set cores = {
      "Macronutrientes": "bg-blue-400",
      "Eletr√≥litos": "bg-blue-300",
      "Estimulantes e Compostos": "bg-blue-200",
      "Vitaminas": "bg-blue-100",
      "Amino√°cidos": "bg-blue-50"
    } %}

    {% for resumo in resumos %}
    <div class="bg-white rounded shadow p-4 mb-6 border border-gray-200">
      <div class="flex justify-between items-start">
        <div onclick="toggleResumo('resumo-{{ loop.index }}')" class="cursor-pointer w-full">
          <h3 class="text-lg font-semibold">{{ resumo.nome_treino }} ({{ resumo.data.strftime('%d/%m/%Y') }})</h3>
          <p class="text-sm text-gray-600">{{ resumo.comentario }}</p>
          <div class="text-sm text-blue-600 mt-1 cursor-pointer detalhes-link" data-id="resumo-{{ loop.index }}">Ver detalhes ‚¨á</div>
        </div>
        <form method="POST" action="{{ url_for('deletar_resumo', id=resumo.id) }}" onsubmit="return confirm('Tem certeza que deseja excluir este resumo?');" class="ml-4">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="text-sm text-red-600">Excluir üóë</button>
        </form>
      </div>    

      <div id="resumo-{{ loop.index }}" class="mt-4 hidden">

        {% if resumo.suplementos_utilizados %}
        <div class="text-sm text-gray-700 mt-2 mb-4">
          <strong>Suplementos utilizados:</strong>
          <ul class="list-disc list-inside mt-1">
            {% for item in resumo.suplementos_utilizados.split(',') %}
              <li>{{ item.strip() }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        <div class="text-sm text-gray-700 mb-4">
          <p><strong>Tempo total:</strong> {{ formatar_tempo_decimal(resumo.tempo_total) }}</p>
          <p><strong>Nata√ß√£o:</strong> {{ formatar_tempo_decimal(resumo.tempo_natacao) }} |
             <strong>Bike:</strong> {{ formatar_tempo_decimal(resumo.tempo_bike) }} |
             <strong>Corrida:</strong> {{ formatar_tempo_decimal(resumo.tempo_corrida) }}</p>
             
        </div>

        {% set ordem = ["Macronutrientes", "Eletr√≥litos", "Estimulantes e Compostos", "Vitaminas",  "Amino√°cidos"] %}
        {% set ordem_eletrolitos = ["S√≥dio", "Magn√©sio", "Pot√°ssio", "C√°lcio"] %}

        {% for categoria in ordem %}
          {% if resumo.resumo_dados[categoria] %}
          <div class="mb-2 p-3 rounded-xl shadow {{ cores[categoria] }}">
            <h4 class="font-semibold text-gray-900 mb-1">{{ icones[categoria] }} {{ categoria }}</h4>
            <ul class="list-disc pl-5 text-sm text-gray-800">
              {% if categoria == "Eletr√≥litos" %}
                {% for item in ordem_eletrolitos %}
                  <li><strong>{{ item }}:</strong> {{ resumo.resumo_dados[categoria][item] }}</li>
                {% endfor %}
              {% else %}
                {% for item, valor in resumo.resumo_dados[categoria].items() %}
                  <li><strong>{{ item }}:</strong> {{ valor }}</li>
                {% endfor %}
              {% endif %}
            </ul>
          </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}









<script>
  const input = document.getElementById('campoBusca');
  const container = document.getElementById('resumosContainer');

  input.addEventListener('input', async () => {
    const termo = input.value.trim();

    const res = await fetch(`/buscar_resumos?termo=${encodeURIComponent(termo)}`);
    const dados = await res.json();

    container.innerHTML = '';

    if (dados.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-500">Nenhum resumo encontrado.</p>';
      return;
    }

    const ordem = ["Macronutrientes", "Eletr√≥litos", "Estimulantes e Compostos",  "Vitaminas", "Amino√°cidos"];
    const ordem_eletrolitos = ["S√≥dio", "Magn√©sio", "Pot√°ssio", "C√°lcio"];

    const icones = {
      "Macronutrientes": "üî•",
      "Eletr√≥litos": "üíß",
      "Estimulantes e Compostos": "‚ö°",
      "Vitaminas": "üíä",
      "Amino√°cidos": "üß¨"
    };
    

    for (const r of dados) {
      const detalhesId = `resumo-${r.id}`;

      let detalhesHTML = `
        <div class="text-sm text-gray-700 mb-4">
          <p><strong>Tempo total:</strong> ${r.tempo_total}h</p>
          <p><strong>Nata√ß√£o:</strong> ${r.tempo_natacao}h |
             <strong>Bike:</strong> ${r.tempo_bike}h |
             <strong>Corrida:</strong> ${r.tempo_corrida}h</p>
        </div>
      `;

      for (const categoria of ordem) {
        const catData = r.resumo_dados?.[categoria];
        if (catData) {
          detalhesHTML += `
            <div class="mb-2">
              <h4 class="font-semibold text-gray-700">${icones[categoria] || ''} ${categoria}</h4>
              <ul class="list-disc pl-5 text-sm text-gray-800">
          `;

          if (categoria === "Eletr√≥litos") {
            for (const item of ordem_eletrolitos) {
              detalhesHTML += `<li><strong>${item}:</strong> ${catData[item] || 0}</li>`;
            }
          } else {
            for (const [item, valor] of Object.entries(catData)) {
              detalhesHTML += `<li><strong>${item}:</strong> ${valor}</li>`;
            }
          }

          detalhesHTML += `</ul></div>`;
        }
      }

      container.innerHTML += `
        <div class="bg-white rounded shadow p-4 mb-4 border border-gray-200">
          <div class="flex justify-between items-start">
            <div onclick="toggleResumo('${detalhesId}')" class="cursor-pointer w-full">
              <h3 class="text-lg font-semibold">${r.nome_treino} (${r.data})</h3>
              <p class="text-sm text-gray-600">${r.comentario}</p>
              <div class="text-sm text-blue-600 mt-1 cursor-pointer">Ver detalhes ‚¨á</div>
            </div>
            <form method="POST" action="/deletar_resumo/${r.id}" onsubmit="return confirm('Tem certeza que deseja excluir este resumo?');" class="ml-4">
              <input type="hidden" name="csrf_token" value="${document.querySelector('[name=csrf_token]').value}">
              <button type="submit" class="text-sm text-red-600">Excluir üóë</button>
            </form>
          </div>

          <div id="${detalhesId}" class="mt-4 hidden">
            ${detalhesHTML}
          </div>
        </div>
      `;
    }
  });

  // ativa o toggle no clique em qualquer "Ver detalhes"
  function toggleResumo(id) {
    const el = document.getElementById(id);
    if (el) el.classList.toggle("hidden");
  }
</script>



{% endblock %}
